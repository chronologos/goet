%%{ init: { "theme": "dark", "themeVariables": { "fontSize": "14px" }, "flowchart": { "rankSpacing": 45, "nodeSpacing": 25, "padding": 16, "subGraphTitleMargin": { "top": 10, "bottom": 10 } } } }%%

graph TD
    TERM[Terminal · raw mode]

    subgraph CLIENT [CLIENT]
        ESC[~. Escape Detector]
        COAL_C[Coalescer · 2ms / 32KB]
        BUF_C[Ring Buffer · 64MB]
        ESC --> COAL_C --> BUF_C
    end

    subgraph TRANSPORT [QUIC over UDP · TLS 1.3]
        CTRL[Stream 0 · Control]
        DATA[Stream 1 · Data]
        AUTH[HMAC-SHA256 Auth]
    end

    subgraph SESSION [SESSION]
        ACCEPT[QUIC Listener · UDP]
        COAL_S[Coalescer · 2ms / 32KB]
        BUF_S[Ring Buffer · 64MB]
        ACCEPT --> COAL_S --> BUF_S
    end

    PTY[PTY Master · xterm-256color]
    SHELL[Login Shell]
    SSH[SSH Bootstrap · ephemeral]

    TERM -->|stdin / stdout| CLIENT
    BUF_C -->|Data seq payload| DATA
    DATA -->|Data seq payload| ACCEPT
    BUF_S -->|read / write| PTY
    PTY -->|fd| SHELL

    TERM -.->|SIGWINCH| CTRL
    CTRL -.->|Resize| PTY
    SSH -.->|passkey + port| SESSION

    classDef termStyle fill:#1e293b,stroke:#f59e0b,stroke-width:2px,color:#fef3c7
    classDef clientStyle fill:#0f172a,stroke:#f97316,stroke-width:2px,color:#fed7aa
    classDef transportStyle fill:#0f172a,stroke:#06b6d4,stroke-width:2px,color:#cffafe
    classDef sessionStyle fill:#0f172a,stroke:#3b82f6,stroke-width:2px,color:#bfdbfe
    classDef nodeStyle fill:#334155,stroke:#64748b,stroke-width:1px,color:#e2e8f0
    classDef shellStyle fill:#4c1d95,stroke:#8b5cf6,stroke-width:1px,color:#ede9fe
    classDef sshStyle fill:#422006,stroke:#f59e0b,stroke-width:1px,stroke-dasharray:5 5,color:#fef3c7

    class CLIENT clientStyle
    class TRANSPORT transportStyle
    class SESSION sessionStyle
    class TERM termStyle
    class PTY,SHELL shellStyle
    class ESC,COAL_C,BUF_C,ACCEPT,COAL_S,BUF_S nodeStyle
    class CTRL,DATA,AUTH nodeStyle
    class SSH sshStyle
